{% extends 'base.html' %}
{% load static %}

{% block title %}Product Details{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/default.min.css">
{% endblock %}

{% block content %}
    <div class="container mx-auto py-8">
        <div class="mb-8">
            <div class="flex justify-center">
                {% if product.image %}
                    <div class="rounded-lg overflow-hidden shadow-lg max-w-screen-md">
                        <img src="{{ product.image.url }}" alt="Image of {{ product.title }}" class="object-cover w-full">
                    </div>
                {% else %}
                    <p>No images available.</p>
                {% endif %}
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <div class="bg-gray-100 p-6 rounded-lg shadow-md">
                    <h2 class="text-3xl font-semibold mb-4">Product Details</h2>
                    <div class="mb-4">
                        <p class="text-gray-700">{{ product.description }}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-gray-700 font-semibold">Category:</p>
                            <p class="text-gray-600">{{ product.category.title }}</p>
                        </div>
                        <div>
                            <p class="text-gray-700 font-semibold">Vendor:</p>
                            <p class="text-gray-600">{{ product.user }}</p>
                        </div>
                    </div>
                    <div class="mt-6">
                        <p class="text-2xl font-semibold">Price: Rs.{{ product.price }}</p>
                        {% if product.get_percentage > 0 %}
                            <p class="text-sm text-gray-500 line-through">Original Price: Rs.{{ product.old_price }}</p>
                            <p class="text-sm text-green-600">Discount: -{{ product.get_percentage|default:"0"|floatformat:0 }}%</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div>
                <div class="bg-gray-100 p-6 rounded-lg shadow-md">
                    <h2 class="text-3xl font-semibold mb-4">Check Availability</h2>
                    <form action="{% url 'check_availability' product.pid %}" method="POST" onsubmit="return checkAvailability(this);">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label for="startDate" class="block text-gray-700 font-semibold mb-2">Check-in Date:</label>
                            <input type="date" id="startDate" name="startDate" class="rounded-lg p-2 border border-gray-300 bg-white w-full" required onfocus="this.min=new Date().toISOString().split('T')[0]">
                        </div>
                        <div class="mb-4 relative">
                            <label for="num_guests" class="block text-gray-700 font-semibold mb-2">Guests:</label>
                            <input type="number" id="num_guests" name="num_guests" class="p-2 border border-gray-300 bg-white w-full" placeholder="Number of Guests" required min="1">
                            <span class="absolute top-full left-0 mt-1 text-sm text-gray-600">*10% discount on more than 4 guests</span>
                        </div>
                        {% if not user.is_authenticated %}
                            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mt-8">
                                <strong class="font-bold">Warning!</strong>
                                <span class="block sm:inline"> You must be logged in to check availability.</span>
                            </div>
                        {% endif %}
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 mt-4 rounded">Check Availability</button>
                    </form>
                    <div class="mt-2 text-gray-700 text-sm">
                        <p>Enter your check-in date and number of guests to check availability.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function checkAvailability(form) {
            event.preventDefault();
            const data = new FormData(form);
            fetch(form.action, {
                method: "POST",
                body: data,
                headers: {
                    "X-CSRFToken": data.get("csrfmiddlewaretoken"),
                },
            })
            .then((response) => response.json())
            .then((data) => {
                console.log(data);
                if (data.available) {
                    Swal.fire(
                        "Available!",
                        "The product is available for booking.",
                        "success"
                    ).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = data.redirect_url;
                        }
                    });
                } else {
                    Swal.fire(
                        "Not Available",
                        "Sorry, the product is not available.",
                        "error"
                    );
                }
            })
            .catch((error) => console.error("Error:", error));
            return false;
        }
    </script>
{% endblock %}